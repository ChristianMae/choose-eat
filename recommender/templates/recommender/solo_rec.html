{% extends 'recommender/base_rec.html' %}

{% block title %}Choose-Eat | Solo{% endblock title %}

{% block header %}Solo Recommendation{% endblock header %}
{% block header_small %}Solo Recommendation{% endblock header_small %}

{% block content %}
<div class="row" id="pre-recommendation">
  <div class="container">
    <div class="col s12">
      <h5 class="otherfont">How far are you willing to go? (km)</h5>
      <form action="#">
        <p class="range-field">
          <input type="range" id="id_distance" min="1" max="40" value="5" />
        </p>
      </form>
    </div>
    <div class="col s12 m5 l5 center-align">
      <form id="keyword_rec">
        {% csrf_token %}
        <div class="row">
          <div class="input-field col s12">
              <input id="id_term" name="term" maxlength="24" type="text" placeholder="What are you looking to eat?" required autocomplete="off">
              <small>Want to eat something specific? Could be some good 'chicken', or a delicious bowl of 'ramen' perhaps?</small> <br/>
          </div>
        </div>
        <button class="btn black waves-effect waves-light otherfont" type="submit" name="action">Submit</button>
      </form>
    </div>
    <div class="col s12 m2 l2">
      <h3 class="otherfont center-align">OR</h3>
    </div>
    <div class="col s12 m5 l5 center-align">
      <a id="nkey_rec" class="waves-effect waves-light btn-large black otherfont pulse" style="margin-top: 6px;"><i class="material-icons left">restaurant_menu</i>Dazzle Me!</a>
      <br /><br />
      <small>Not really looking for anything specific, but just want awesome food that'll match your taste? Leave it to us!</small> <br/>
    </div>
    <p class="white-text" id="id_latitude"></pre>
    <p class="white-text" id="id_longitude"></pre>
  </div>
</div>

<div class="row" id="loading">
  <div class="col s12 center">
    <br /><br />
    <div class="preloader-wrapper big active">
      <div class="spinner-layer spinner-red-only center-align">
        <div class="circle-clipper left">
          <div class="circle"></div>
        </div><div class="gap-patch">
          <div class="circle"></div>
        </div><div class="circle-clipper right">
          <div class="circle"></div>
        </div>
      </div>
    </div>
    <h5 class="otherfont" id="loadingtxt">Fetching results...</h4>
  </div>
</div>

<div class="row" id="results">
  <div class="col s12 center">
    <a id="resto-link" href=""><img id="resto-img" class="z-depth-4" style="border: 3px solid black; height:250px;width:350px; border-radius: 35%;" src=""/></a>
    <h4 id="resto-name" class="otherfont"></h3>
    <p id="resto-address"></p>
    <span class="center-align"><small id="resto-distance"></small> | <small id="resto-categories"></small></span><br /><br />
    <a class="btn-floating btn-large waves-effect waves-light red" href="javascript:nextResto();"><i class="material-icons">not_interested</i></a>
    <a class="btn-floating btn-large waves-effect waves-light blue" href="javascript:previousResto();"><i class="material-icons">replay</i></a>
    <a class="btn-floating btn-large waves-effect waves-light green" href="javascript:acceptResto();"><i class="material-icons">check</i></a>
  </div>
</div>

<div class="row" id="no-results">
  <div class="col s12 center">
    <br/>
    <h4 class="otherfont">No results found for "<span id="usedterm"></span>". Try using a different keyword!</h4>
    <br/>
    <a class="waves-effect waves-light btn-large black otherfont" href="javascript:retryRec();"><i class="material-icons left">find_replace</i>Try Again</a>
  </div>
</div>

<div id="accepted">
  <div class="row">
    <div id="map" class="col s12 m6 l6" style="height:500px;"></div>
    <div id="right-panel" class="col s12 m6 l6" style="height:500px;"></div>
  </div>
</div>
{% endblock content %}

{% block javascript %}
<script>
var index = 0;
var restoList = {};
var actualIndex = 0;
var resultList;
var subtext = document.getElementById('subtext'); 

$(document).ready(function(){
  getLocation();
  $('#loading').hide();
  $('#results').hide();
  $('#no-results').hide();
  $('#accepted').hide();
});

$(".button-collapse").sideNav();
$('.dropdown-button').dropdown({
    inDuration: 300,
    outDuration: 225,
    constrainWidth: true, // Does not change width of dropdown to that of the activator
    hover: true, // Activate on hover
    gutter: 0, // Spacing from edge
    belowOrigin: true, // Displays dropdown below the button
    alignment: 'left', // Displays dropdown with edge aligned to the left of button
    stopPropagation: false // Stops event propagation
  }
);

$('#keyword_rec').on('submit', function(e) {
  e.preventDefault();
  showSoloRec(e);
});
$('#nkey_rec').on('click', function(e) {
  showSoloRec(e);
});

function showSoloRec(event) {
  var params = {
    latitude: 7.0689124,
    longitude: 125.6018725,
    uid: {{ user.id }},
    distance: $('#id_distance').val() * 1000
  };

  if (event.target.id === 'keyword_rec') {
    params.term = $('#id_term').val();
    document.getElementById('id_term').value=null;
  }

  $.ajax({
    type: 'GET',
    url: '{% url 'soloRec' %}',
    data: params,
    beforeSend: function() {
      $('#pre-recommendation').hide();
      $('#loading').show();
      var x = document.getElementById('loadingtxt'), 
      messages = ['Anytime now...', 'This is taking longer than expected...'],
      i = 0;
      setInterval(function () {
        x.innerHTML = messages[i++];
        i = messages.length === i ? 0 : i;
      }, 5000);
    },
    complete: function(response) {
      $('#loading').hide();
    },
    success: function(response) {
      restoList = response;
      console.log(restoList);
      if (restoList.likes.length == 0 && restoList.semilikes.length == 0 && restoList.others.length == 0 && restoList.dislikes.length == 0) {
        document.getElementById('usedterm').innerHTML = params.term;
        $('#no-results').show();
      } else {
        nextResto();
        $('#results').show();
      }
    }
  });
}

function retryRec() {
  $('#no-results').hide();
  $('#pre-recommendation').show();
}

function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      document.getElementById("id_latitude").innerHTML = '' +position.coords.latitude;
      document.getElementById("id_longitude").innerHTML = '' +position.coords.longitude;
    });
  } else { 
    alert("Geolocation is not supported by this browser :( Try using a different browser or get the mobile app!");
  }
}

function nextResto() {
  if (index < restoList.likes.length) {
    actualIndex = index;
    resultList = restoList.likes;
    subtext.innerHTML = "You'll surely love these!"
  } else if (index-restoList.likes.length < restoList.semilikes.length) {
    actualIndex = index-restoList.likes.length;
    resultList = restoList.semilikes;
    subtext.innerHTML = "You'll probably like these too!"
  } else if (index-restoList.likes.length-restoList.semilikes.length < restoList.others.length) {
    actualIndex = index-restoList.likes.length-restoList.semilikes.length;
    resultList = restoList.others;
    subtext.innerHTML = "Try these ones out!"
  } else if (index-restoList.likes.length-restoList.semilikes.length-restoList.others.length < restoList.dislikes.length) {
    actualIndex = index-restoList.likes.length-restoList.semilikes.length-restoList.others.length;
    resultList = restoList.dislikes;
    subtext.innerHTML = "Not too sure about these ones..."
  } else {
    index = 0;
    actualIndex = 0;
    resultList = restoList.likes;
    subtext.innerHTML = "That was all of them! Back to start!"
  }

  var categories = [];
  for (var i = 0; i < resultList[actualIndex].categories.length; i++) {
    categories.push(resultList[actualIndex].categories[i].title);
  }
  var address = resultList[actualIndex].location.address2 === '' || resultList[actualIndex].location.address2 === null ? resultList[actualIndex].location.address1 : resultList[actualIndex].location.address1+', '+resultList[actualIndex].location.address2;

  document.getElementById('resto-link').href = resultList[actualIndex].url;
  document.getElementById('resto-img').src = resultList[actualIndex].image_url;
  document.getElementById('resto-name').innerHTML = resultList[actualIndex].name;
  document.getElementById('resto-address').innerHTML = address;
  document.getElementById('resto-distance').innerHTML = 'Approx. '+(resultList[actualIndex].distance/1000).toFixed(1)+' km away';
  document.getElementById('resto-categories').innerHTML = categories.join(', ');

  index++;
}

function previousResto() {
  if (index === 1) {
    Materialize.toast('We are just getting started!', 3000, 'rounded');
  } else {
    index = index-2 < 0 ? 0 : index-2;
    nextResto();
  }
}

function acceptResto() {
  document.getElementById('hdr').innerHTML = resultList[actualIndex].name;
  document.getElementById('hdr2').innerHTML = resultList[actualIndex].name;
  document.getElementById('subtext').innerHTML = "Mode of Travel:<br/><div class='col m4 l4'></div><select id='mode' class='browser-default col s12 m4 l4'><option value='DRIVING'>Driving</option><option value='WALKING'>Walking</option><option value='BICYCLING'>Bicycling</option><option value='TRANSIT'>Transit</option></select>";
  initMap();
  $('#results').hide();
  $('#accepted').show();
}

function initMap() {
  var directionsDisplay = new google.maps.DirectionsRenderer;
  var directionsService = new google.maps.DirectionsService;
  var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 10,
    center: {lat: 7.0689124, lng: 125.6018725}
  });
  directionsDisplay.setMap(map);
  directionsDisplay.setPanel(document.getElementById('right-panel'));

  calculateAndDisplayRoute(directionsService, directionsDisplay);
  document.getElementById('mode').addEventListener('change', function() {
    calculateAndDisplayRoute(directionsService, directionsDisplay);
  });
}

function calculateAndDisplayRoute(directionsService, directionsDisplay) {
  var selectedMode = document.getElementById('mode').value;
  var dest;
  if (resultList[actualIndex].coordinates.latitude === null || resultList[actualIndex].coordinates.longitude === null) {
    dest = resultList[actualIndex].location.display_address.join(', ');
  } else {
    dest = {
      lat: resultList[actualIndex].coordinates.latitude,
      lng: resultList[actualIndex].coordinates.longitude
    };
  }
  console.log(dest);
  directionsService.route({
    origin: {lat: 7.0689124, lng: 125.6018725}, 
    destination: dest,  
    travelMode: google.maps.TravelMode[selectedMode]
  }, function(response, status) {
    if (status == 'OK') {
      directionsDisplay.setDirections(response);
    } else {
      window.alert('Directions request failed due to ' + status);
    }
  });
}
</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ googlekey }}">
    </script>
{% endblock %}

